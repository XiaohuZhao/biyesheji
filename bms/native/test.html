<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>新增成果</title>
</head>
<body>
<!--suppress JSUnfilteredForInLoop -->
<form class="layui-form" style="margin-top: 32px;">
    <label style="margin: 50px;font-size: 32px;width: 300px">基本信息</label>
    <div class="layui-form-item" style="margin-top: 24px;">
        <label class="layui-form-label">论文题目</label>
        <div class="layui-input-inline">
            <input type="text" name="title" required lay-verify="required"
                   autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">第一作者</label>
        <div class="layui-input-inline">
            <input type="text" name="firstAuthor" required lay-verify="required"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">所属单位</label>
        <div class="layui-input-inline">
            <select name="department" lay-verify="required">
                <option value="其他">其他</option>
                <option value="计算机学院">计算机学院</option>
                <option value="软件学院">软件学院</option>
            </select>
        </div>

        <label class="layui-form-label">学校署名</label>
        <div class="layui-input-inline">
            <select name="college" lay-verify="required">
                <option value="一级单位">一级单位</option>
                <option value="非一级单位">非一级单位</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">一级学科</label>
        <div class="layui-input-inline">
            <select name="subject" lay-verify="required">
                <option value="其他">其他</option>
                <option value="计算机科学技术">计算机科学技术</option>
            </select>
        </div>

        <label class="layui-form-label">学课门类</label>
        <div class="layui-input-inline">
            <select name="categories" lay-verify="required">
                <option value="其他">其他</option>
                <option value="社科类">社科类</option>
                <option value="教育类">教育类</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">刊物类型</label>
        <div class="layui-input-inline">
            <select name="publishType" lay-verify="required">
                <option value="其他">其他</option>
                <option value="中文普通期刊">中文普通期刊</option>
                <option value="CSSCI">CSSCI</option>
                <option value="外文期刊">外文期刊</option>
            </select>
        </div>

        <label class="layui-form-label" style="width: 90px">发表/出版时间</label>
        <div class="layui-input-inline">
            <input name="publishTime" type="text" class="layui-input" id="timeSelector">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">发表范围</label>
        <div class="layui-input-inline">
            <select name="publishScope" lay-verify="required">
                <option value="国内公开发行">国内公开发行</option>
                <option value="国外公开发行">国外公开发行</option>
                <option value="国内外公开发行">国内外公开发行</option>
            </select>
        </div>

        <label class="layui-form-label">字数(万)</label>
        <div class="layui-input-inline">
            <input type="number" name="wordCount" required lay-verify="required" autocomplete="off"
                   min="0.0001"
                   step="0.01" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">CN/ISSN号</label>
        <div class="layui-input-inline">
            <input type="text" name="cnIssn" required lay-verify="required" autocomplete="off"
                   class="layui-input">
        </div>
        <label class="layui-form-label">是否为译文</label>
        <div class="layui-input-inline">
            <input type="radio" name="translation" value="1" title="是">
            <input type="radio" name="translation" value="0" title="否" checked>
        </div>
    </div>
    <label style="margin: 50px;font-size: 32px;width: 300px">作者信息</label>
    <table class="layui-table" style="width: 50%" lay-filter="authors">
        <thead>
        <tr>
            <th style="width: 70px">署名顺序</th>
            <th>作者姓名</th>
            <th style="width: 70px">性别</th>
            <th>所属单位</th>
            <th style="width: 70px">贡献率(%)</th>
            <th style="width: 70px">操作</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>
                <input type="number" name="seq" required lay-verify="required" autocomplete="off"
                       class="layui-input">
            </td>
            <td>
                <input type="text" name="authorName" required lay-verify="required" autocomplete="off"
                       class="layui-input">
            </td>
            <td>
                <select name="gender" lay-verify="required">
                    <option value="0">其他</option>
                    <option value="1">男</option>
                    <option value="2">女</option>
                </select>
            </td>
            <td>
                <input type="text" name="department" required lay-verify="required" autocomplete="off"
                       class="layui-input">
            </td>
            <td>
                <input type="number" name="contribution" required lay-verify="required" autocomplete="off"
                       class="layui-input">
            </td>
            <td>
                <a href="javascript:void(0)" onclick="insert(this)">新增</a>
            </td>
        </tr>
        </tbody>
    </table>
    <label style="margin: 80px 50px 50px;font-size: 32px;width: 300px">附件信息</label>
    <div class="layui-input-inline">
        <button type="button" class="layui-btn" id="fileUpload" style="margin-top: -15px;">
            <i class="layui-icon">&#xe67c;</i>上传图片
        </button>
        <form enctype="multipart/form-data">
            <input id="fileUploadInput" type="file" name="file" hidden>
        </form>
    </div>
    <button id="submit" type="button" class="layui-btn">提交</button>
</form>

<script>
    $("#submit").click(function () {
        let data = {
            title: $("input[name='title']").val(),
            firstAuthor: $("input[name='firstAuthor']").val(),
            department: $("select[name='department']").val(),
            college: $("select[name='college']").val(),
            subject: $("select[name='subject']").val(),
            categories: $("select[name='categories']").val(),
            publishType: $("select[name='publishType']").val(),
            publishTime: $("input[name='publishTime']").val(),
            publishScope: $("select[name='publishScope']").val(),
            wordCount: $("input[name='wordCount']").val(),
            cnIssn: $("input[name='cnIssn']").val(),
            translation: $("input[name='translation']:checked").val(),
            authors,
            attachments
        };
        console.log(data)
    });
    layui.use('form', function () {
        let form = layui.form;
        form.render();
    });
    layui.use('laydate', function () {
        const laydate = layui.laydate;
        //执行一个laydate实例
        laydate.render({
            elem: '#timeSelector' //指定元素
            , format: 'yyyy-MM-dd'
        });
    });

    let authors = [];
    let attachments = [];

    function insert(obj) {
        let $tr = $(obj).parent().parent();
        let $tds = $tr.children("td");
        let seq = $tds.eq(0).find('input[name="seq"]').val();
        console.log(seq);
        if (seq == null || seq === '') {
            layer.msg('署名顺序不可为空', {icon: 5});
            return
        }
        let authorName = $tds.eq(1).find('input[name="authorName"]').val();
        let genderCode = $tds.eq(2).find('select[name="gender"]').val();
        let gender = $tds.eq(2).find('select[name="gender"]').find("option:selected").text();
        let department = $tds.eq(3).find('input[name="department"]').val();
        let contribution = $tds.eq(4).find('input[name="contribution"]').val();
        let row = {seq, authorName, genderCode, department, contribution};
        for (let index in authors) {
            if (authors[index].seq === seq) {
                layer.msg('署名顺序不可相同', {icon: 5});
                return
            }
        }
        authors.push(row);
        $tr.before($(`<tr>
                        <td>
                            ${seq}
                        </td>
                        <td>
                            ${authorName}
                        </td>
                        <td>
                            ${gender}
                        </td>
                        <td>
                            ${department}
                        </td>
                        <td>
                            ${contribution}
                        </td>
                        <td>
                            <a href="javascript:void(0)" onclick="remove(this)">移除</a>
                        </td>
                    </tr>`));
        $tds.eq(0).find('input[name="seq"]').val("");
        $tds.eq(1).find('input[name="authorName"]').val("");
        $tds.eq(2).find('select[name="gender"]').val("0");
        $tds.eq(3).find('input[name="department"]').val("");
        $tds.eq(4).find('input[name="contribution"]').val("");
        layui.use('form', function () {
            var form = layui.form;
            form.render();
        })
    }

    function remove(obj) {
        let $tr = $(obj).parent().parent();
        $tr.remove();
        console.log($tr)
    }

    $("#fileUpload").click(function () {
        console.log("fileUpload");
        $("#fileUploadInput").click()
    });
    $('#fileUploadInput').on('change', function () {
        let files = $('#fileUploadInput')[0].files;
        console.log(files);
        const formData = new FormData();
        formData.append("file", files[0]);
        $.ajax({
            url: `${globalService.basePath}/file/upload`,
            type: 'post',
            data: formData,
            processData: false,//必填 必须false 才会避开jq对formdata的默认处理 XMLHttpRequest才会对formdata进行正确处理  否则会报Illegal invocation错误
            contentType: false,//必填 必须false 才会加上正确的Content-Type
            success: function (res) {
                if (res.ret) {
                    console.log(res.data.filePath);
                    layer.msg("上传成功", {icon: 1, time: 2000}, function () {
                        layer.closeAll();
                        attachments.push(res.data.filePath)
                    })
                }
            }
        })
    })
</script>
</body>
</html>